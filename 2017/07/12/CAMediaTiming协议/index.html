<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="iOS," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="前言最近正在读 《iOS-Core-Animation-Advanced-Techniques》 这本书，先读的github上的翻译版，在图层时间这一章中，它讲的并不是很清楚，很多地方给我很多困惑。然后自己做了一些实验，再加上参考了stackoverflow上的一些回答之后，整理了图层时间的一些知识，如有错误还请指出。
CoreAnimation的计时机制时间对于动画是十分重要的。单一动画有自己的">
<meta property="og:type" content="article">
<meta property="og:title" content="CAMediaTiming协议">
<meta property="og:url" content="http://yoursite.com/2017/07/12/CAMediaTiming协议/index.html">
<meta property="og:site_name" content="Mr.W的文字站">
<meta property="og:description" content="前言最近正在读 《iOS-Core-Animation-Advanced-Techniques》 这本书，先读的github上的翻译版，在图层时间这一章中，它讲的并不是很清楚，很多地方给我很多困惑。然后自己做了一些实验，再加上参考了stackoverflow上的一些回答之后，整理了图层时间的一些知识，如有错误还请指出。
CoreAnimation的计时机制时间对于动画是十分重要的。单一动画有自己的">
<meta property="og:updated_time" content="2017-07-24T02:43:34.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CAMediaTiming协议">
<meta name="twitter:description" content="前言最近正在读 《iOS-Core-Animation-Advanced-Techniques》 这本书，先读的github上的翻译版，在图层时间这一章中，它讲的并不是很清楚，很多地方给我很多困惑。然后自己做了一些实验，再加上参考了stackoverflow上的一些回答之后，整理了图层时间的一些知识，如有错误还请指出。
CoreAnimation的计时机制时间对于动画是十分重要的。单一动画有自己的">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/07/12/CAMediaTiming协议/"/>





  <title> CAMediaTiming协议 | Mr.W的文字站 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-103060845-1', 'auto');
  ga('send', 'pageview');
</script>











  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Mr.W的文字站</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle">727348402@qq.com，欢迎交流~</p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/12/CAMediaTiming协议/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Mr.W">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Mr.W的文字站">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Mr.W的文字站" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                CAMediaTiming协议
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-12T18:48:57+08:00">
                2017-07-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv">浏览
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>次
            </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近正在读 《iOS-Core-Animation-Advanced-Techniques》 这本书，先读的github上的<a href="https://github.com/AttackOnDobby/iOS-Core-Animation-Advanced-Techniques" target="_blank" rel="external">翻译版</a>，在图层时间这一章中，它讲的并不是很清楚，很多地方给我很多困惑。然后自己做了一些实验，再加上参考了stackoverflow上的一些回答之后，整理了图层时间的一些知识，如有错误还请指出。</p>
<h1 id="CoreAnimation的计时机制"><a href="#CoreAnimation的计时机制" class="headerlink" title="CoreAnimation的计时机制"></a>CoreAnimation的计时机制</h1><p>时间对于动画是十分重要的。单一动画有自己的持续时间，多个动画的执行有时间上的先后顺序。动画的行为需要按时间来进行组织和串联，也就是动画的执行需要一个时间来参照，这就需要动画有自己的计时机制。CoreAnimation确实提供一种计时的机制，来控制和追踪动画的时间。这种机制就是CAAnimation定义的CAMediaTiming协议。</p>
<p>CALayer和CAAnimation都实现了该协议。因为，CAAnimation需要参照时间执行动画，CALayer也需要参照时间来组织添加到其及其子CALayer上的动画。通过该协议CALayer和CAAnimation都可以控制动画的时间上的行为。不过，该协议的一些属性在CALayer上的表现效果和CAAnimation上的表现效果具有明显差异，具体下面会讲，这也是我写这篇博客的原因。</p>
<p>在讲CAMediaTiming协议之前，先讲一下动画参照时间的层级关系和动画的层级关系。</p>
<h2 id="动画参照时间的层级关系"><a href="#动画参照时间的层级关系" class="headerlink" title="动画参照时间的层级关系"></a>动画参照时间的层级关系</h2><p>CALayer实现了CAMediaTiming协议。CALayer会有自己的动画参照时间，添加到CALayer上的动画都是按照该动画参照时间来组织的。</p>
<p>CALayer是有层级关系的，CALayer是按照树形结构来进行组织的。因为动画都是添加到CALayer上的，所以动画时间也有层级关系。层级关系体现在下面几点：</p>
<ul>
<li>动画执行所直接参照的时间并不是一个全局的时间，而是每个CALayer有自己的参照时间，并且同一个CALayer上的所有动画参照同一个时间</li>
<li>本CACALayer的参照时间，来源于其父CALayer的参照时间，具体的时间转换公式下面会讲到</li>
<li>所有的CALayer的参照时间，都是由 <em>马赫时间</em> 通过一层层的转换得到的，<em>马赫时间</em> 就是动画所参照的一个全局时间（或者说根时间，我自己这么称呼…），这也是所有的动画能够同步到一起的根本原因</li>
</ul>
<p>马赫时间可以通过下面的函数得到：</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">CFTimeInterval time</span> = CACurrentMediaTime();</div></pre></td></tr></table></figure>
<p>不同CALayer的动画参照时间可以通过下面的方法来转换：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">- <span class="params">(CFTimeInterval)</span>convertTime:<span class="params">(CFTimeInterval)</span>t fromLayer:<span class="params">(CALayer *)</span>l;</div><div class="line">- <span class="params">(CFTimeInterval)</span>convertTime:<span class="params">(CFTimeInterval)</span>t toLayer:<span class="params">(CALayer *)</span>l;</div></pre></td></tr></table></figure>
<h2 id="动画的层级关系"><a href="#动画的层级关系" class="headerlink" title="动画的层级关系"></a>动画的层级关系</h2><p>动画所添加到的CALayer具有层级关系，动画也存在着层级关系，但是动画的层级关系仅仅体现在CAAnimationGroup。</p>
<p>比如说，一个CAAnimationGroup有两个动画，其中一个是平移动画，其余一个是旋转动画。这就是一个两层关系的动画组。控制动画组中各个动画在时间上的行为也需要CAMediaTiming协议。</p>
<h1 id="CAMediaTiming-Protocol"><a href="#CAMediaTiming-Protocol" class="headerlink" title="CAMediaTiming Protocol"></a>CAMediaTiming Protocol</h1><p>该协议定义了一个属性集，包括这些属性：duration、speed、beginTime、timeOffset、fillMode等。由于CAAnimation和CALayer都实现了该协议，并且这些属性在这两种对象上的表现效果不同，所以我分开来讲。</p>
<h2 id="CAAnimation的实现"><a href="#CAAnimation的实现" class="headerlink" title="CAAnimation的实现"></a>CAAnimation的实现</h2><h3 id="duration"><a href="#duration" class="headerlink" title="duration"></a>duration</h3><p>该属性定义了动画执行的时间，单位是s，简单明了。</p>
<h3 id="speed"><a href="#speed" class="headerlink" title="speed"></a>speed</h3><p>speed控制时间的流速，默认是1.0。如果变为2.0，意味着原来2s的动画1s就能完成。</p>
<h3 id="beginTime"><a href="#beginTime" class="headerlink" title="beginTime"></a>beginTime</h3><p>beginTime表示动画在添加到图层时和开始执行时之间的时间，默认是0。如果赋值为1的话，意味着在 addAnimation:forKey:执行之后，动画不会立即执行，会等待1s再开始执行。这也是通俗易懂的。</p>
<p>但是，这里又分两种情况：</p>
<h4 id="情况一"><a href="#情况一" class="headerlink" title="情况一"></a>情况一</h4><p>要配置的动画在CAAnimationGroup中话，那么beginTime的效果就像我们上面说的一样。若设置为1的话，就是相对于动画组开始的时刻晚1s再开始该动画。</p>
<p>例如：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">CABasicAnimation *anim1 = ...<span class="comment">;</span></div><div class="line">anim1.duration = <span class="number">2</span><span class="comment">;</span></div><div class="line">anim1.<span class="keyword">beginTime </span>= <span class="number">1</span><span class="comment">;</span></div><div class="line">...</div><div class="line"></div><div class="line">CABasicAnimation *anim2 = ...<span class="comment">;</span></div><div class="line">...</div><div class="line"></div><div class="line">CAAnimationGroup *animGroup = ...<span class="comment">;</span></div><div class="line">animGroup.duration = <span class="number">3</span><span class="comment">;</span></div><div class="line">animGroup.animations = @[anim1, anim2]<span class="comment">;</span></div><div class="line"></div><div class="line">[layer <span class="keyword">addAnimation:animGroup </span>forKey:nil]<span class="comment">;</span></div></pre></td></tr></table></figure>
<p>上述动画的效果是：layer先开始执行动画二，1s后动画一开始执行，然后动画一和二同时执行2s后结束。</p>
<h4 id="情况二"><a href="#情况二" class="headerlink" title="情况二"></a>情况二</h4><p>要配置的动画被直接添加到CALayer中的话，那么beginTime的效使用和效果会和上面介绍的不同。</p>
<p>例如情况一的代码中，animGroup被直接添加到layer，如果添加下面一句：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">animGroup.<span class="keyword">beginTime </span>= <span class="number">1</span><span class="comment">;</span></div></pre></td></tr></table></figure>
<p>这并不代表着该动画组会在1s后开始执行，相反动画永远不会开始执行。因为，对于直接添加到layer的CAAnimation，beginTime属性表示动画开始执行的时刻，并不是执行之前的等待的时间。这里的动画开始执行的时刻是以layer的本地时间为参考的。</p>
<p>如果想让上述的动画组在1s后开始执行，那么就需要这样设置beginTime：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">animGroup.beginTime = [layer <span class="string">convertTime:</span>CACurrentMediaTime() <span class="string">fromLayer:</span>nil] + <span class="number">1</span>;</div><div class="line">[layer <span class="string">addAnimation:</span>animGroup <span class="string">forKey:</span>nil];</div></pre></td></tr></table></figure>
<p>这句代码的含义是，先根据马赫时间得到当前的layer的动画参考时间，再把动画组开始执行的时刻设置为‘当前时间’的下一秒。需要注意的是，设置完动画组的beginTime后，需要立刻把动画组添加到layer中，这样才能保证‘动画添加到layer中的时间’是‘当前时间’，才能保证恰好在1s后开始执行动画。</p>
<p>但是beginTime的默认值是0，这并不意味着在layer本地时间中的0时刻开始动画，这表示当动画添加到layer中后立即开始执行。这很奇怪，但是事实却是如此。</p>
<h3 id="timeOffset"><a href="#timeOffset" class="headerlink" title="timeOffset"></a>timeOffset</h3><p>timeOffset默认是0，表示动画开始执行时的时间偏移，也就是动画从timeOffset秒的状态开始执行，然而执行的时间不变。因为执行的时间不变所以动画执行到尾后会再从头开始，直到执行满duration。具体用个例子说明：</p>
<p>对于一个2s的动画，如果timeOffset赋值为1的话，表示该动画从1s的状态开始执行，执行两秒，超出的时间会循环执行。比如该动画是2s内把layer从（0，0）向右平移100到（0，100）。那么timeOffset赋1后，实际的效果是layer突然从（0，0）变到（0，50），然后花1s向右平移到（0，100），再突然变到（0，0），然后花1s向右平移到（0，50），最后变到（0，0）。</p>
<p>如果timeOffset和speed混合使用的话，speed不会影响timeOffset的使用。例如还是上面的2s的平移动画，speed是2，timeOffset是1，那么实际的效果不是从（0，100）开始执行；而是还从（0，50）开始执行，只不过运行速度变为原来的两倍。</p>
<p>timeOffset不像上面的beginTime一样分两种情况，只有一种含义和效果。</p>
<h3 id="fillMode"><a href="#fillMode" class="headerlink" title="fillMode"></a>fillMode</h3><p>fillMode具体从网上搜吧，没有什么好讲的。</p>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><p>这些属性的配置都是在动画添加到图层之前，也就是说：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span>. CAAnimation *anim = ...<span class="comment">;</span></div><div class="line"><span class="number">2</span>. anim.<span class="keyword">blabla </span>= ...<span class="comment">;</span></div><div class="line"><span class="number">3</span>. [layer <span class="keyword">addAnimation:anim </span>forKey:nil]<span class="comment">;</span></div></pre></td></tr></table></figure>
<p>在CAAnimation添加到图层之后，再去改变这些属性是没有用的，即使用property存下来了这些CAAnimation。因为添加到图层的是CAAnimation的readOnly的深拷贝。</p>
<p>例如，我试图在 - (void)animationDidStart:(CAAnimation *)anim方法中改变动画的duration属性，就报出如下错误。</p>
<figure class="highlight ocaml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">*** <span class="type">Terminating</span> app due <span class="keyword">to</span> uncaught <span class="keyword">exception</span> <span class="symbol">'CAAnimationImmutable'</span>, reason: <span class="symbol">'attempting</span> <span class="keyword">to</span> modify read-only animation &lt;<span class="type">CAAnimationGroup</span>: <span class="number">0x608000228760</span>&gt;<span class="string">'</span></div></pre></td></tr></table></figure>
<h2 id="CALayer的实现"><a href="#CALayer的实现" class="headerlink" title="CALayer的实现"></a>CALayer的实现</h2><h3 id="duration-1"><a href="#duration-1" class="headerlink" title="duration"></a>duration</h3><p>对CALayer来讲，该属性没有任何意义，对该属性赋值不能控制该CALayer上动画的执行时间，相反会导致不可预期的错误。所以一般我们不用该属性。</p>
<h3 id="speed-1"><a href="#speed-1" class="headerlink" title="speed"></a>speed</h3><p>该属性对CALayer和CAAnimation没有区别。如果CAAnimation的speed是2，其所添加到CALayer的speed是2。那么时间的流速会变为4倍，也就是原来4s的动画1s就能完成。</p>
<h3 id="beginTime-1"><a href="#beginTime-1" class="headerlink" title="beginTime"></a>beginTime</h3><p>CALayer的beginTime默认为0，是用来控制layer的本地动画参照时间的。</p>
<p>每一个layer的动画参照时间都是由其父layer的动画参照时间转换来的。从CAMediaTiming.h中可以找到转换公式： t = (tp - beginTime) * speed + timeOffset，其中tp是父layer的时间，t是本layer的时间。因此，更改beginTime会导致layer的时间变化。例如：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"before: %f"</span>,[layer convertTime:<span class="built_in">CACurrentMediaTime</span>() fromLayer:<span class="literal">nil</span>]);</div><div class="line">layer.beginTime = <span class="number">5</span>;</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"after: %f"</span>,[layer convertTime:<span class="built_in">CACurrentMediaTime</span>() fromLayer:<span class="literal">nil</span>]);</div></pre></td></tr></table></figure>
<p>执行上述代码，打印出的信息是：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">2017<span class="selector-tag">-07-12</span> 11<span class="selector-pseudo">:29</span><span class="selector-pseudo">:20.765</span> <span class="selector-tag">Test</span><span class="selector-attr">[2261:73200]</span> <span class="selector-tag">before</span>: 8479<span class="selector-class">.008420</span></div><div class="line">2017<span class="selector-tag">-07-12</span> 11<span class="selector-pseudo">:29</span><span class="selector-pseudo">:20.766</span> <span class="selector-tag">Test</span><span class="selector-attr">[2261:73200]</span> <span class="selector-tag">after</span>: 8474<span class="selector-class">.008894</span></div></pre></td></tr></table></figure>
<p>由此可见，更改beginTime使得layer的参照时间减少了5s，这和公式是符合的。<br>如果设置beginTime = 5， speed = 2，那么打印结果如下：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">2017<span class="selector-tag">-07-12</span> 11<span class="selector-pseudo">:32</span><span class="selector-pseudo">:20.747</span> <span class="selector-tag">Test</span><span class="selector-attr">[2312:76112]</span> <span class="selector-tag">before</span>: 8658<span class="selector-class">.993300</span></div><div class="line">2017<span class="selector-tag">-07-12</span> 11<span class="selector-pseudo">:32</span><span class="selector-pseudo">:20.747</span> <span class="selector-tag">Test</span><span class="selector-attr">[2312:76112]</span> <span class="selector-tag">after</span>: 17307<span class="selector-class">.987721</span></div></pre></td></tr></table></figure>
<p>这也是符合预期的。</p>
<p>利用上面介绍的原理，可以通过设置beginTime来更改layer的本地时间，从而达到让layer上的动画等待几秒再开始的效果。具体的做法如下：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">CFTimeInterval curTime = [self.testLayer convertTime:CACurrentMediaTime() fromLayer:nil]<span class="comment">;</span></div><div class="line">layer.<span class="keyword">beginTime </span>= <span class="number">2</span><span class="comment">;</span></div><div class="line">anim.<span class="keyword">beginTime </span>= curTime<span class="comment">;</span></div><div class="line">[layer <span class="keyword">addAnimation:anim </span>forKey:nil]<span class="comment">;</span></div></pre></td></tr></table></figure>
<p><code>anim.beginTime = curTime;</code>这句话是必要的。如果没有这句话的话，那么对layer.beginTime的更改会毫无意义。因为anim.beginTime是0的话，anim总会立刻执行。这里我推测，anim.beginTime为0的话，动画的beginTime属性会在addAnimation:forKey:之后，被自动设置为添加动画后的那个时刻执行；如果anim.beginTime不为0，那么动画会被设置为当本地时间计时到beginTime的时候才执行。因此，上面的代码先设置了动画的执行时刻，然后通过设置layer.beginTime把本地时间减少2s，这样就实现了2s后动画才执行的效果。</p>
<p>然后，为了证实上面的推测，我设置了一个beginTime是默认的动画，然后在动画的回调方法里面打印出beginTime。</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- <span class="params">(void)</span>animationDidStart:<span class="params">(CAAnimation *)</span>anim&#123;</div><div class="line">    NSLog<span class="params">(@<span class="string">"anim.beginTime %f"</span>, anim.beginTime)</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>结果发现，打印出的结果不是0，而是一个值是几千的浮点数。然后我在<code>[layer addAnimation:anim forKey:nil];</code>后，打印出layer本地时间。发现这两个值基本相同。这就说明即使默认beginTime，系统也会给beginTime赋一个合适的值，触发动画也是通过layer的本地时间和beginTime的值比较进行的。</p>
<h3 id="timeOffset-1"><a href="#timeOffset-1" class="headerlink" title="timeOffset"></a>timeOffset</h3><p>CALayer的timeOffset默认为0，这个属性在上一小节介绍的公式中有提到。通常这个属性也用来改变layer的本地时间，和CAAnimation的timeOffset没有关系。</p>
<p>在这里我做了小小的测试：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">CFTimeInterval curTime = [self.testLayer convertTime:CACurrentMediaTime() fromLayer:nil]<span class="comment">;</span></div><div class="line">layer.<span class="keyword">beginTime </span>= <span class="number">2</span><span class="comment">;</span></div><div class="line">layer.timeOffset = <span class="number">2</span><span class="comment">;</span></div><div class="line">anim.<span class="keyword">beginTime </span>= curTime<span class="comment">;</span></div><div class="line">[layer <span class="keyword">addAnimation:anim </span>forKey:nil]<span class="comment">;</span></div></pre></td></tr></table></figure>
<p>动画的效果是立即执行，符合由公式推测出的结果。</p>
<h3 id="注意事项-1"><a href="#注意事项-1" class="headerlink" title="注意事项"></a>注意事项</h3><p>需要注意的是，在使用beginTime、speed、timeOffset改变layer的本地时间的时候，需要考虑layer上动画beginTime是默认值还是自定义的值。如果是默认值，那么动画不受影响；如果是自定义的值的话，那就要考虑改变本地时间对动画造成的影响。</p>
<h1 id="CAMediaTiming的应用"><a href="#CAMediaTiming的应用" class="headerlink" title="CAMediaTiming的应用"></a>CAMediaTiming的应用</h1><p>使用CAMediaTiming协议可以实现一些好用的功能，这里介绍两个常用的功能。</p>
<h2 id="手势控制动画进度"><a href="#手势控制动画进度" class="headerlink" title="手势控制动画进度"></a>手势控制动画进度</h2><p>因为我们可以通过beginTime、speed、timeOffset改变layer的本地时间，所以我们可以通过把layer的speed设置为0，然后通过timeOffset属性来控制layer本地时间的计时。这样就可以随心控制layer上的动画的进度。如果我们把timeOffset的值和手势识别器关联起来，那么就能实现手势控制动画进度的效果。</p>
<p>下面我实现了一个左右拖动控制平移动画进度的效果。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="comment">// Do any additional setup after loading the view, typically from a nib.</span></div><div class="line">    <span class="keyword">self</span>.testLayer = [<span class="built_in">CALayer</span> layer];</div><div class="line">    <span class="keyword">self</span>.testLayer.frame = <span class="built_in">CGRectMake</span>(<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">30</span>);</div><div class="line">    <span class="keyword">self</span>.testLayer.backgroundColor = [<span class="built_in">UIColor</span> redColor].CGColor;</div><div class="line">    [<span class="keyword">self</span>.view.layer addSublayer:<span class="keyword">self</span>.testLayer];</div><div class="line">    </div><div class="line">    <span class="built_in">CABasicAnimation</span> *anim = [<span class="built_in">CABasicAnimation</span> animation];</div><div class="line">    anim.keyPath = <span class="string">@"transform.translation.x"</span>;</div><div class="line">    anim.byValue = @<span class="number">300</span>;</div><div class="line">    anim.duration = <span class="number">3</span>;</div><div class="line">    </div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"before %f"</span>, [<span class="keyword">self</span>.testLayer convertTime:<span class="built_in">CACurrentMediaTime</span>() fromLayer:<span class="literal">nil</span>]);</div><div class="line">    <span class="keyword">self</span>.testLayer.speed = <span class="number">0</span>; <span class="comment">// interesting</span></div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"after %f"</span>, [<span class="keyword">self</span>.testLayer convertTime:<span class="built_in">CACurrentMediaTime</span>() fromLayer:<span class="literal">nil</span>]);</div><div class="line">    [<span class="keyword">self</span>.testLayer addAnimation:anim forKey:<span class="literal">nil</span>];</div><div class="line">    </div><div class="line">    <span class="built_in">UIPanGestureRecognizer</span> *pan = [[<span class="built_in">UIPanGestureRecognizer</span> alloc] initWithTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(pan:)];</div><div class="line">    [<span class="keyword">self</span>.view addGestureRecognizer:pan];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)pan:(<span class="built_in">UIPanGestureRecognizer</span> *)pan</div><div class="line">&#123;</div><div class="line">    <span class="comment">//get horizontal component of pan gesture</span></div><div class="line">    <span class="built_in">CGFloat</span> x = [pan translationInView:<span class="keyword">self</span>.view].x;</div><div class="line">    <span class="comment">//convert from points to animation duration //using a reasonable scale factor</span></div><div class="line">    x /= <span class="number">300.0</span>f;</div><div class="line">    x *= <span class="number">3</span>;</div><div class="line">    <span class="comment">//update timeOffset and clamp result</span></div><div class="line">    <span class="built_in">CFTimeInterval</span> timeOffset = <span class="keyword">self</span>.testLayer.timeOffset;</div><div class="line">    timeOffset = MIN(<span class="number">2.999</span>, MAX(<span class="number">0.0</span>, timeOffset + x));</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"old timeOffset %f , new timeOffset %f, x %f"</span>, <span class="keyword">self</span>.testLayer.timeOffset, timeOffset, x);</div><div class="line">    <span class="keyword">self</span>.testLayer.timeOffset = timeOffset;</div><div class="line">    <span class="comment">//reset pan gesture</span></div><div class="line">    [pan setTranslation:<span class="built_in">CGPointZero</span> inView:<span class="keyword">self</span>.view];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>有意思的一点是，无论<code>self.testLayer.speed = 0;</code>在<code>`[self.testLayer addAnimation:anim forKey:nil];</code>之前执行还是之后执行，上面的代码都有效。这也意味着，如果anim的beginTime是默认，anim的beginTime实际赋值并不是刚好在anim被添加到layer时。经过测试，anim的赋值是在viewDidLoad之后。我把添加动画的代码通过按钮触发，经过测试，anim的beginTime赋值是在按钮的IBAction执行之后。</p>
<h2 id="暂停与继续动画"><a href="#暂停与继续动画" class="headerlink" title="暂停与继续动画"></a>暂停与继续动画</h2><p>动画的暂停与继续的原理也是控制layer的本地时间。具体的做法参考<a href="https://stackoverflow.com/questions/20946481/comprehend-pause-and-resume-animation-on-a-layer" target="_blank" rel="external">这篇帖子</a>，讲的很详细，我就不再废话了。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/iOS/" rel="tag"># iOS</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/06/19/iOS中的离屏渲染/" rel="next" title="iOS中的离屏渲染">
                <i class="fa fa-chevron-left"></i> iOS中的离屏渲染
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/07/19/RunLoop/" rel="prev" title="RunLoop">
                RunLoop <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="Mr.W" />
          <p class="site-author-name" itemprop="name">Mr.W</p>
           
              <p class="site-description motion-element" itemprop="description">一个不善表达的工科男</p>
          
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CoreAnimation的计时机制"><span class="nav-number">2.</span> <span class="nav-text">CoreAnimation的计时机制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#动画参照时间的层级关系"><span class="nav-number">2.1.</span> <span class="nav-text">动画参照时间的层级关系</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#动画的层级关系"><span class="nav-number">2.2.</span> <span class="nav-text">动画的层级关系</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CAMediaTiming-Protocol"><span class="nav-number">3.</span> <span class="nav-text">CAMediaTiming Protocol</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#CAAnimation的实现"><span class="nav-number">3.1.</span> <span class="nav-text">CAAnimation的实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#duration"><span class="nav-number">3.1.1.</span> <span class="nav-text">duration</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#speed"><span class="nav-number">3.1.2.</span> <span class="nav-text">speed</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#beginTime"><span class="nav-number">3.1.3.</span> <span class="nav-text">beginTime</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#情况一"><span class="nav-number">3.1.3.1.</span> <span class="nav-text">情况一</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#情况二"><span class="nav-number">3.1.3.2.</span> <span class="nav-text">情况二</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#timeOffset"><span class="nav-number">3.1.4.</span> <span class="nav-text">timeOffset</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fillMode"><span class="nav-number">3.1.5.</span> <span class="nav-text">fillMode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#注意事项"><span class="nav-number">3.1.6.</span> <span class="nav-text">注意事项</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CALayer的实现"><span class="nav-number">3.2.</span> <span class="nav-text">CALayer的实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#duration-1"><span class="nav-number">3.2.1.</span> <span class="nav-text">duration</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#speed-1"><span class="nav-number">3.2.2.</span> <span class="nav-text">speed</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#beginTime-1"><span class="nav-number">3.2.3.</span> <span class="nav-text">beginTime</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#timeOffset-1"><span class="nav-number">3.2.4.</span> <span class="nav-text">timeOffset</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#注意事项-1"><span class="nav-number">3.2.5.</span> <span class="nav-text">注意事项</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CAMediaTiming的应用"><span class="nav-number">4.</span> <span class="nav-text">CAMediaTiming的应用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#手势控制动画进度"><span class="nav-number">4.1.</span> <span class="nav-text">手势控制动画进度</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#暂停与继续动画"><span class="nav-number">4.2.</span> <span class="nav-text">暂停与继续动画</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mr.W</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

<div class="busuanzi-count">

  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">访问人数<span class="busuanzi-value" id="busuanzi_value_site_uv"></span>次</span>
  

  
    <span class="site-pv">总访问量<span class="busuanzi-value" id="busuanzi_value_site_pv"></span>次</span>
  
  
</div>



        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  





  



  
  

  

  

  

  


</body>
</html>
